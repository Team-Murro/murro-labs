# backend/menu.py
import ollama
import json
import random
from datetime import datetime

# 음식 전문가 페르소나 (수정됨)
SYSTEM_PROMPT = """
당신은 20년 경력의 미식가이자 영양사입니다. 
사용자의 현재 시간, 위치, 상황을 고려하여 점심 또는 저녁 메뉴 6가지를 추천합니다.

[절대 원칙]
1. **메뉴 이름은 수식어를 뺀 '일반 명사'로만 출력하세요.**
   - (X) 나쁜 예: "얼큰한 짬뽕", "제주식 고기국수", "면옥전복라면", "할머니표 된장찌개"
   - (O) 좋은 예: "짬뽕", "고기국수", "라면", "된장찌개", "김치찌개", "돈까스"
2. 한국인 입맛에 맞는 호불호 적은 대중적인 메뉴 위주로 추천하세요.
3. 답변은 오직 **JSON 데이터만** 출력하세요.

JSON 형식:
{
  "reason": "비가 오는 날에는 따뜻한 국물이 생각나죠. (추천 이유 한줄)",
  "menus": ["메뉴1", "메뉴2", "메뉴3", "메뉴4", "메뉴5", "메뉴6"]
}
"""

async def get_menu_recommendation(lat: float, lng: float, current_time: str):
    # (이하 코드는 기존과 동일)
    month = datetime.now().month
    season = "겨울" if month in [12, 1, 2] else "봄" if month in [3, 4, 5] else "여름" if month in [6, 7, 8] else "가을"
    
    user_prompt = f"""
    [상황]
    - 현재 시간: {current_time}
    - 현재 계절: {season}
    - 사용자 위치(좌표): {lat}, {lng} 
    
    지금 먹기 딱 좋은 대중적인 식사 메뉴 6가지를 JSON으로 추천해줘. 메뉴 이름은 짧게 명사만 써줘.
    """

    try:
        response = ollama.chat(
            model='llama3.1',
            messages=[
                {'role': 'system', 'content': SYSTEM_PROMPT},
                {'role': 'user', 'content': user_prompt},
            ],
            format='json',
            options={'temperature': 0.8}
        )
        
        content = response['message']['content']
        return json.loads(content)
        
    except Exception as e:
        print(f"🚨 메뉴 추천 에러: {e}")
        return {
            "reason": "AI가 고민하다가 배가 고파졌습니다. 무난한 메뉴들입니다.",
            "menus": ["돈까스", "김치찌개", "짜장면", "햄버거", "순대국", "제육볶음"]
        }
