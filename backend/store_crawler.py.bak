# backend/store_crawler.py
import asyncio
import re
from playwright.async_api import async_playwright
from sqlalchemy.orm import Session
from database import SessionLocal
from models import WinningStore
from sqlalchemy import func

# --- ì„¤ì • ---
START_TURN = 262
MAX_TURN = 2000

async def crawl_past_winning_stores():
    print("ğŸ•µï¸â€â™‚ï¸ [ëª…ë‹¹ ìˆ˜ì§‘ê¸°] ì—­ëŒ€ ë‹¹ì²¨ì  í¬ë¡¤ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...")

    db: Session = SessionLocal()
    last_saved = db.query(func.max(WinningStore.turn)).scalar()
    
    if last_saved is None or last_saved < 262:
        current_turn = START_TURN
    else:
        current_turn = last_saved + 1
        
    print(f"ğŸ”„ {current_turn}íšŒì°¨ë¶€í„° ìˆ˜ì§‘ì„ ì‹œì‘í•©ë‹ˆë‹¤. (ë§ˆì§€ë§‰ ì €ì¥: {last_saved or 'ì—†ìŒ'})")
    
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)
        context = await browser.new_context(
            user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36",
            viewport={"width": 1920, "height": 1080}
        )
        page = await context.new_page()
        
        target_url = "https://www.dhlottery.co.kr/wnprchsplcsrch/home"
        print(f"ğŸŒ ì§€ë„ í˜ì´ì§€ ì ‘ì† ì¤‘... ({target_url})")
        
        try:
            await page.goto(target_url, wait_until='networkidle', timeout=60000)
        except:
            print("âš ï¸ í˜ì´ì§€ ë¡œë”© ì§€ì—° (ì¼ë‹¨ ì§„í–‰)")

        try:
            await page.wait_for_selector("#srchLtEpsd", state="attached", timeout=10000)
        except:
            print("âŒ í˜ì´ì§€ ë¡œë”© ì‹¤íŒ¨.")
            await browser.close()
            return

        while current_turn < MAX_TURN:
            try:
                print(f"\nâ³ [{current_turn}íšŒì°¨] ìˆ˜ì§‘ ì‹œë„...", end="", flush=True)

                # ì˜µì…˜ í™•ì¸
                option_count = await page.locator(f"#srchLtEpsd option[value='{current_turn}']").count()
                if option_count == 0:
                    print(f"\nâœ… ìµœì‹  íšŒì°¨ ë„ë‹¬.")
                    break

                # 1. íšŒì°¨ ì„ íƒ
                await page.select_option("#srchLtEpsd", str(current_turn))
                
                # 2. ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
                await page.click('#btnSrch')
                await page.wait_for_timeout(2000) 

                stores_to_save = []

                # ============================================================
                # 1ï¸âƒ£ [1ë“± ë°ì´í„° ìˆ˜ì§‘]
                # ============================================================
                try:
                    # íƒ­ ê°•ì œ ì „í™˜ (jQuery)
                    await page.evaluate("""() => {
                        $('#srchLtWnRank li[value="all"]').removeClass('tagTab');
                        $('#srchLtWnRank li[value="2"]').removeClass('tagTab');
                        $('#srchLtWnRank li[value="1"]').addClass('tagTab'); // UI í‘œì‹œìš©
                        $('#srchLtWnRank li[value="1"]').trigger('click');   // ì‹¤ì œ ë™ì‘
                    }""")
                    await page.wait_for_timeout(1000)
                except:
                    pass

                # ğŸ”¥ [ìˆ˜ì •ë¨] ì •í™•í•œ ì„ íƒìë¡œ 1ë“± ì•„ì´í…œ ê°€ì ¸ì˜¤ê¸°
                items = await page.locator("#storeDiv .store-box").all()
                
                for item in items:
                    try:
                        # í…ìŠ¤íŠ¸ ì¶”ì¶œ (ì—†ì„ ê²½ìš° ëŒ€ë¹„)
                        store_name = await item.locator(".store-loc").inner_text()
                        rank_text = await item.locator(".draw-rank").inner_text()
                        address = await item.locator(".shpAddr").inner_text()
                        
                        # ê²Œì„ ë°©ì‹ (ìë™/ìˆ˜ë™)
                        game_type = "ì•Œìˆ˜ì—†ìŒ"
                        if await item.locator(".draw-opt").count() > 0:
                            game_type = await item.locator(".draw-opt").inner_text()

                        # 1ë“±ì¸ì§€ í™•ì¸ (íƒ­ì„ ëˆŒë €ì–´ë„ ë”ë¸” ì²´í¬)
                        if "1ë“±" in rank_text:
                            stores_to_save.append(WinningStore(
                                turn=current_turn, rank=1, store_name=store_name.strip(), 
                                address=address.strip(), game_type=game_type.strip()
                            ))
                    except Exception as e:
                        continue # íŒŒì‹± ì—ëŸ¬ ì‹œ ìŠ¤í‚µ

                print(f" 1ë“±({len(stores_to_save)}ê³³)", end="..")

                # ============================================================
                # 2ï¸âƒ£ [2ë“± ë°ì´í„° ìˆ˜ì§‘]
                # ============================================================
                try:
                    await page.evaluate("""() => {
                        $('#srchLtWnRank li[value="1"]').removeClass('tagTab');
                        $('#srchLtWnRank li[value="2"]').addClass('tagTab');
                        $('#srchLtWnRank li[value="2"]').trigger('click');
                    }""")
                    await page.wait_for_timeout(1000)
                except:
                    pass

                # í˜ì´ì§• ë£¨í”„
                page_num = 1
                while True:
                    # í˜„ì¬ í˜ì´ì§€ ì•„ì´í…œ ìˆ˜ì§‘
                    items_2nd = await page.locator("#storeDiv .store-box").all()
                    
                    has_new_data = False
                    for item in items_2nd:
                        try:
                            store_name = await item.locator(".store-loc").inner_text()
                            rank_text = await item.locator(".draw-rank").inner_text()
                            address = await item.locator(".shpAddr").inner_text()
                            
                            # 2ë“±ë§Œ ìˆ˜ì§‘
                            if "2ë“±" in rank_text:
                                store_name = store_name.strip()
                                # ì¤‘ë³µ ì²´í¬
                                if not any(s.rank == 2 and s.store_name == store_name for s in stores_to_save):
                                    stores_to_save.append(WinningStore(
                                        turn=current_turn, rank=2, store_name=store_name, 
                                        address=address.strip(), game_type=None
                                    ))
                                    has_new_data = True
                        except:
                            continue
                    
                    if not has_new_data: break

                    # ğŸ”¥ [ìˆ˜ì •ë¨] ë‹¤ìŒ í˜ì´ì§€ í´ë¦­ ë¡œì§ (í˜ì´ì§€ êµ¬ì¡° ë°˜ì˜)
                    try:
                        next_clicked = await page.evaluate(f"""(pageNum) => {{
                            // ìˆ«ì ë²„íŠ¼ í´ë¦­
                            const links = document.querySelectorAll('.pagination-ul .page-link');
                            for(let a of links) {{
                                if(a.innerText.trim() === String(pageNum + 1)) {{ 
                                    a.click(); 
                                    return true; 
                                }}
                            }}
                            // í™”ì‚´í‘œ(ë‹¤ìŒ) ë²„íŠ¼ í´ë¦­ (alt='ë‹¤ìŒí˜ì´ì§€' ì´ë¯¸ì§€ í¬í•¨ëœ ë§í¬)
                            const nextBtn = document.querySelector('.pagination-ul .btn-arrow a img[alt="ë‹¤ìŒí˜ì´ì§€"]');
                            if(nextBtn && nextBtn.parentElement && nextBtn.parentElement.parentElement) {{
                                nextBtn.parentElement.parentElement.click();
                                return true;
                            }}
                            return false;
                        }}""", page_num)

                        if next_clicked:
                            await page.wait_for_timeout(800)
                            page_num += 1
                        else:
                            break
                    except: break

                print(f" 2ë“±í¬í•¨ ëˆ„ì ({len(stores_to_save)}ê³³) ì™„ë£Œ!", end="")

                if stores_to_save:
                    db.add_all(stores_to_save)
                    db.commit()

                current_turn += 1

            except Exception as e:
                print(f"\nâš ï¸ {current_turn}íšŒì°¨ ì—ëŸ¬: {e}")
                current_turn += 1
        
        await browser.close()
        db.close()
        print("\nğŸ‰ ì™„ë£Œ!")

if __name__ == "__main__":
    asyncio.run(crawl_past_winning_stores())
