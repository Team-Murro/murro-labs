'use client';

import { useState, useEffect, Suspense, useRef } from 'react';
import Script from 'next/script';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';

declare global {
  interface Window {
    kakao: any;
  }
}

interface MapStoreAgg {
  name: string;
  lat: number;
  lng: number;
  first_count: number;
  second_count: number;
}

function MapContent() {
  const [map, setMap] = useState<any>(null);
  const [stores, setStores] = useState<MapStoreAgg[]>([]);
  const [isMapLoaded, setIsMapLoaded] = useState(false); 
  
  const mapRef = useRef<any>(null);
  const currentInfowindow = useRef<any>(null);

  const searchParams = useSearchParams();
  const focusLat = searchParams.get('lat');
  const focusLng = searchParams.get('lng');
  const focusName = searchParams.get('name');

  const API_BASE = '';
  const KAKAO_MAP_KEY = "9cc09fdfe6ab741a49587a4afcccf613";

  useEffect(() => {
    fetch(`${API_BASE}/api/stores/all`)
      .then(res => res.json())
      .then(data => setStores(data))
      .catch(err => console.error(err));
  }, []);

  useEffect(() => {
    if (mapRef.current) return;
    const checkInterval = setInterval(() => {
      // [ìˆ˜ì •] ì„œë¹„ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ê¹Œì§€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ë„ë¡ ì¡°ê±´ ê°•í™” ê°€ëŠ¥í•˜ë‚˜, 
      // URLì„ í†µì¼í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ëŒ€ë¶€ë¶„ í•´ê²°ë©ë‹ˆë‹¤.
      if (window.kakao && window.kakao.maps && document.getElementById('map')) {
        clearInterval(checkInterval);
        window.kakao.maps.load(() => {
          const container = document.getElementById('map');
          if (!container) return;
          const options = { center: new window.kakao.maps.LatLng(37.5665, 126.9780), level: 5 };
          const newMap = new window.kakao.maps.Map(container, options);
          mapRef.current = newMap; 
          setMap(newMap);          
          setIsMapLoaded(true);    
          window.kakao.maps.event.addListener(newMap, 'click', function() {
            if (currentInfowindow.current) {
              currentInfowindow.current.close();
              currentInfowindow.current = null;
            }
          });
        });
      }
    }, 100); 
    return () => clearInterval(checkInterval);
  }, []); 

  useEffect(() => {
    if (map && stores.length > 0) {
      stores.forEach(store => {
        const position = new window.kakao.maps.LatLng(store.lat, store.lng);
        const imageSrc = store.first_count > 0 ? "http://maps.google.com/mapfiles/ms/icons/red-dot.png" : "http://maps.google.com/mapfiles/ms/icons/blue-dot.png";
        const imageSize = new window.kakao.maps.Size(32, 32); 
        const markerImage = new window.kakao.maps.MarkerImage(imageSrc, imageSize);

        const marker = new window.kakao.maps.Marker({
          position: position,
          map: map,
          title: store.name,
          clickable: true,
          image: markerImage
        });

        const iwContent = `
          <div style="padding:10px; color:#333; font-size:12px; min-width:180px; border-radius:8px; background:white;">
            <div style="font-weight:bold; margin-bottom:5px;">${store.name}</div>
            <div style="font-size:11px;">1ë“±: <span style="color:red; font-weight:bold;">${store.first_count}íšŒ</span> / 2ë“±: <span style="color:blue;">${store.second_count}íšŒ</span></div>
          </div>
        `;
        const infowindow = new window.kakao.maps.InfoWindow({ content: iwContent });

        window.kakao.maps.event.addListener(marker, 'click', function() {
          if (currentInfowindow.current) currentInfowindow.current.close();
          infowindow.open(map, marker);
          currentInfowindow.current = infowindow;
        });
      });

      if (focusLat && focusLng && focusName) {
        const moveLatLon = new window.kakao.maps.LatLng(parseFloat(focusLat), parseFloat(focusLng));
        map.setCenter(moveLatLon);
        map.setLevel(3); 
        const iwContent = `<div style="padding:5px; color:black; font-weight:bold;">ğŸ“ ${focusName}</div>`;
        const infowindow = new window.kakao.maps.InfoWindow({ content: iwContent, position: moveLatLon });
        infowindow.open(map);
        currentInfowindow.current = infowindow;
      } else {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((pos) => {
              const lat = pos.coords.latitude;
              const lng = pos.coords.longitude;
              const loc = new window.kakao.maps.LatLng(lat, lng);
              map.setCenter(loc);
              map.setLevel(5); 
            }, () => {});
        }
      }
    }
  }, [map, stores, focusLat, focusLng, focusName]);

  const handleFindMe = () => {
    if (!map || !navigator.geolocation) return alert("ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
    const btn = document.getElementById('my-loc-btn');
    if(btn) btn.innerText = "íƒìƒ‰ ì¤‘...";
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const loc = new window.kakao.maps.LatLng(lat, lng);
      map.setCenter(loc);
      map.setLevel(5);
      new window.kakao.maps.Marker({ position: loc, map: map, title: "ë‚´ ìœ„ì¹˜" });
      if(btn) btn.innerText = "ğŸ“ ë‚´ ìœ„ì¹˜";
    }, () => {
      alert("ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      if(btn) btn.innerText = "ğŸ“ ë‚´ ìœ„ì¹˜";
    });
  };

  return (
    <>
      {/* [ìˆ˜ì •] libraries=services ì¶”ê°€í•˜ì—¬ ë§›ì§‘ ì§€ë„ì™€ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì†Œ í†µì¼ */}
      <Script 
        src={`//dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_MAP_KEY}&libraries=services&autoload=false`} 
        strategy="afterInteractive" 
      />
      <div className="absolute top-4 left-4 z-20">
        <Link href="/" className="bg-slate-900/90 text-white px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-slate-800 transition-all border border-slate-600 text-xs font-mono">
          â† HOME
        </Link>
      </div>
      <button 
        id="my-loc-btn"
        onClick={handleFindMe}
        className="absolute bottom-8 right-4 z-20 bg-blue-600 text-white p-3 rounded-full shadow-xl hover:bg-blue-500 transition-all font-bold text-xs font-mono border border-blue-400"
      >
        ğŸ“ ë‚´ ìœ„ì¹˜
      </button>
      <div id="map" className="w-full h-screen bg-slate-900 relative">
        {!isMapLoaded && (
          <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-white z-10">
            <div className="w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p className="text-xs text-slate-400 font-mono animate-pulse">LOADING MAP...</p>
          </div>
        )}
      </div>
    </>
  );
}

export default function MapPage() {
  return (
    <Suspense fallback={<div className="text-white text-center p-10 font-mono">Loading...</div>}>
      <MapContent />
    </Suspense>
  );
}
